{% extends "base.html" %}

{% block title %}Blind Play - Chess Training Platform{% endblock %}

{% block content %}
<h2><i class="bi bi-eye-slash"></i> Blind Play Training</h2>
<p class="lead">Train your visualization skills by playing chess without seeing the board!</p>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">Game Controls</h6>
            </div>
            <div class="card-body">
                <div id="gameStatus" class="alert alert-info">
                    Ready to start
                </div>
                <button class="btn btn-success w-100 mb-2" id="startBtn" onclick="startGame()">Start New Game</button>
                <button class="btn btn-warning w-100 mb-2" id="showBoardBtn" onclick="toggleBoard()" disabled>Show/Hide Board</button>
                <button class="btn btn-danger w-100" onclick="endGame()">End Game</button>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label">Your Move</label>
                    <input type="text" class="form-control" id="moveInput" placeholder="e.g., e2-e4" disabled>
                    <button class="btn btn-primary w-100 mt-2" onclick="makeMove()" disabled id="makeMoveBtn">Make Move</button>
                </div>
                
                <div>
                    <h6>Move History</h6>
                    <div id="moveHistory" class="p-2 bg-light" style="height: 200px; overflow-y: auto;">
                        No moves yet
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-body text-center">
                <div id="boardContainer" style="display: none;">
                    <h5>Chess Board (Hint Mode)</h5>
                    <div id="board" style="width: 100%; max-width: 600px; margin: 0 auto;"></div>
                </div>
                <div id="blindContainer">
                    <div class="py-5">
                        <i class="bi bi-eye-slash display-1 text-muted"></i>
                        <h4 class="text-muted mt-3">Visualize the board in your mind</h4>
                        <p class="text-muted">Use algebraic notation to make your moves</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">Tips for Blind Play</h6>
            </div>
            <div class="card-body">
                <ul>
                    <li>Start with simple positions and work your way up</li>
                    <li>Visualize the board square by square</li>
                    <li>Keep track of piece positions mentally</li>
                    <li>Use move notation: piece + target square (e.g., Nf3, e4)</li>
                    <li>You can peek at the board occasionally if needed</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
let game = null;
let board = null;
let moveCount = 0;
let startTime = null;
let boardVisible = false;

function startGame() {
    game = new Chess();
    board = Chessboard('board', {
        position: 'start',
        draggable: false
    });
    
    moveCount = 0;
    startTime = Date.now();
    boardVisible = false;
    
    document.getElementById('moveInput').disabled = false;
    document.getElementById('makeMoveBtn').disabled = false;
    document.getElementById('showBoardBtn').disabled = false;
    document.getElementById('startBtn').textContent = 'Restart Game';
    document.getElementById('gameStatus').className = 'alert alert-success';
    document.getElementById('gameStatus').textContent = 'Game in progress - Your turn (White)';
    document.getElementById('moveHistory').textContent = 'Game started';
    
    document.getElementById('boardContainer').style.display = 'none';
    document.getElementById('blindContainer').style.display = 'block';
}

function makeMove() {
    const moveInput = document.getElementById('moveInput').value.trim();
    if (!moveInput) return;
    
    try {
        // Try different move formats
        let move = null;
        
        // Try standard algebraic notation
        move = game.move(moveInput);
        
        // If that fails, try from-to notation
        if (!move && moveInput.includes('-')) {
            const [from, to] = moveInput.split('-');
            move = game.move({ from: from.trim(), to: to.trim() });
        }
        
        if (move) {
            moveCount++;
            updateMoveHistory(move.san, 'white');
            
            if (board && boardVisible) {
                board.position(game.fen());
            }
            
            // Make computer move
            setTimeout(makeComputerMove, 500);
            
            document.getElementById('moveInput').value = '';
        } else {
            alert('Invalid move! Try again.');
        }
    } catch (error) {
        alert('Invalid move format! Use notation like "e4", "Nf3", or "e2-e4"');
    }
}

function makeComputerMove() {
    const moves = game.moves();
    
    if (moves.length === 0) {
        endGame();
        return;
    }
    
    // Simple random move for opponent
    const randomMove = moves[Math.floor(Math.random() * moves.length)];
    game.move(randomMove);
    
    updateMoveHistory(randomMove, 'black');
    
    if (board && boardVisible) {
        board.position(game.fen());
    }
    
    // Check if game is over
    if (game.game_over()) {
        endGame();
    } else {
        document.getElementById('gameStatus').textContent = 'Your turn (White)';
    }
}

function updateMoveHistory(move, player) {
    const historyDiv = document.getElementById('moveHistory');
    const moveNumber = Math.floor(moveCount / 2) + 1;
    const color = player === 'white' ? 'text-primary' : 'text-danger';
    
    if (player === 'white') {
        historyDiv.innerHTML += `<div><strong>${moveNumber}.</strong> <span class="${color}">${move}</span>`;
    } else {
        const lastLine = historyDiv.lastElementChild;
        if (lastLine) {
            lastLine.innerHTML += ` <span class="${color}">${move}</span></div>`;
        }
    }
    
    historyDiv.scrollTop = historyDiv.scrollHeight;
}

function toggleBoard() {
    boardVisible = !boardVisible;
    
    if (boardVisible) {
        document.getElementById('boardContainer').style.display = 'block';
        document.getElementById('blindContainer').style.display = 'none';
        board.position(game.fen());
    } else {
        document.getElementById('boardContainer').style.display = 'none';
        document.getElementById('blindContainer').style.display = 'block';
    }
}

async function endGame() {
    if (!game) return;
    
    const duration = Math.floor((Date.now() - startTime) / 1000);
    let result = 'draw';
    
    if (game.in_checkmate()) {
        result = game.turn() === 'w' ? 'loss' : 'win';
    }
    
    // Save game
    const token = localStorage.getItem('token');
    if (token) {
        try {
            await fetch('/games/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    game_type: 'blind_play',
                    result: result,
                    moves: game.pgn(),
                    duration: duration
                })
            });
            
            alert(`Game ended! Result: ${result}. Duration: ${duration}s`);
        } catch (error) {
            console.error('Failed to save game');
        }
    }
    
    // Reset
    document.getElementById('moveInput').disabled = true;
    document.getElementById('makeMoveBtn').disabled = true;
    document.getElementById('showBoardBtn').disabled = true;
    document.getElementById('gameStatus').className = 'alert alert-info';
    document.getElementById('gameStatus').textContent = `Game ended - ${result}`;
}

// Enter key to make move
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('moveInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            makeMove();
        }
    });
});
</script>
{% endblock %}
