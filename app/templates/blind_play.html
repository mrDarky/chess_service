{% extends "base.html" %}

{% block title %}Blind Play - Chess Training Platform{% endblock %}

{% block content %}
<h2><i class="bi bi-eye-slash"></i> Blind Play Training</h2>
<p class="lead">Train your visualization skills by playing chess without seeing the board!</p>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0">Game Controls</h6>
            </div>
            <div class="card-body">
                <div id="gameStatus" class="alert alert-info">
                    Ready to start
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Number of Boards</label>
                    <select class="form-select" id="boardCount">
                        <option value="1">1 Board</option>
                        <option value="2">2 Boards</option>
                        <option value="3">3 Boards</option>
                        <option value="4">4 Boards</option>
                        <option value="5">5 Boards</option>
                        <option value="6">6 Boards</option>
                        <option value="7">7 Boards</option>
                        <option value="8">8 Boards</option>
                        <option value="9">9 Boards</option>
                        <option value="10">10 Boards</option>
                    </select>
                </div>
                
                <button class="btn btn-success w-100 mb-2" id="startBtn" onclick="startGame()">Start New Game</button>
                <button class="btn btn-danger w-100 mb-2" onclick="endAllGames()">End All Games</button>
                
                <hr>
                
                <div class="mb-3">
                    <label class="form-label">Select Board</label>
                    <select class="form-select mb-2" id="activeBoardSelect" disabled>
                        <option value="0">Board 1</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Your Move</label>
                    <input type="text" class="form-control" id="moveInput" placeholder="e.g., e2-e4" disabled>
                    <button class="btn btn-primary w-100 mt-2" onclick="makeMove()" disabled id="makeMoveBtn">Make Move</button>
                </div>
                
                <div>
                    <h6>Move History (Current Board)</h6>
                    <div id="moveHistory" class="p-2 bg-light" style="height: 200px; overflow-y: auto;">
                        No moves yet
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div id="boardsContainer" class="row">
            <!-- Boards will be dynamically added here -->
        </div>
        
        <div id="blindContainer" class="card">
            <div class="card-body text-center">
                <div class="py-5">
                    <i class="bi bi-eye-slash display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">Select number of boards and click Start</h4>
                    <p class="text-muted">Boards will be blurred by default to train visualization</p>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">Tips for Blind Play</h6>
            </div>
            <div class="card-body">
                <ul>
                    <li>Start with simple positions and work your way up</li>
                    <li>Visualize the board square by square</li>
                    <li>Keep track of piece positions mentally</li>
                    <li>Use move notation: piece + target square (e.g., Nf3, e4)</li>
                    <li>You can peek at the board occasionally if needed</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

<script>
let games = []; // Array to hold multiple game instances
let boards = []; // Array to hold multiple board instances
let moveHistory = []; // Array to hold move history for each board
let startTimes = []; // Array to hold start times for each board
let blurStates = []; // Array to hold blur state for each board

function getColumnClass(boardCount) {
    if (boardCount === 1) return 'col-12';
    if (boardCount <= 4) return 'col-md-6';
    return 'col-md-4';
}

function startGame() {
    const boardCount = parseInt(document.getElementById('boardCount').value);
    
    // Clear existing games
    games = [];
    boards = [];
    moveHistory = [];
    startTimes = [];
    blurStates = [];
    
    // Hide blind container
    document.getElementById('blindContainer').style.display = 'none';
    
    // Clear boards container
    const boardsContainer = document.getElementById('boardsContainer');
    boardsContainer.innerHTML = '';
    
    // Create board selection dropdown
    const boardSelect = document.getElementById('activeBoardSelect');
    boardSelect.innerHTML = '';
    
    // Initialize boards
    for (let i = 0; i < boardCount; i++) {
        // Create game instance
        games[i] = new Chess();
        moveHistory[i] = [];
        startTimes[i] = Date.now();
        blurStates[i] = true; // Default to blurred
        
        // Create board container
        const colClass = getColumnClass(boardCount);
        const boardCard = document.createElement('div');
        boardCard.className = `${colClass} mb-3`;
        boardCard.innerHTML = `
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">Board ${i + 1}</h6>
                    <button class="btn btn-sm btn-light" onclick="toggleBoardBlur(${i})">
                        <i class="bi bi-eye" id="blurIcon${i}"></i>
                    </button>
                </div>
                <div class="card-body p-2">
                    <div id="board${i}" class="chess-board blurred" style="width: 100%;"></div>
                </div>
            </div>
        `;
        boardsContainer.appendChild(boardCard);
        
        // Initialize chessboard
        boards[i] = Chessboard(`board${i}`, {
            position: 'start',
            draggable: false
        });
        
        // Add to dropdown
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `Board ${i + 1}`;
        boardSelect.appendChild(option);
    }
    
    // Enable controls
    document.getElementById('moveInput').disabled = false;
    document.getElementById('makeMoveBtn').disabled = false;
    document.getElementById('activeBoardSelect').disabled = false;
    document.getElementById('startBtn').textContent = 'Restart Games';
    document.getElementById('gameStatus').className = 'alert alert-success';
    document.getElementById('gameStatus').textContent = `${boardCount} game(s) in progress`;
    
    // Update move history for first board
    updateMoveHistoryDisplay();
    
    // Set initial blur on all boards
    for (let i = 0; i < boardCount; i++) {
        const boardElement = document.getElementById(`board${i}`);
        if (boardElement) {
            boardElement.classList.add('blurred');
        }
    }
}

function toggleBoardBlur(boardIndex) {
    blurStates[boardIndex] = !blurStates[boardIndex];
    const boardElement = document.getElementById(`board${boardIndex}`);
    const iconElement = document.getElementById(`blurIcon${boardIndex}`);
    
    if (blurStates[boardIndex]) {
        boardElement.classList.add('blurred');
        iconElement.className = 'bi bi-eye';
    } else {
        boardElement.classList.remove('blurred');
        iconElement.className = 'bi bi-eye-slash';
    }
}

function makeMove() {
    const moveInput = document.getElementById('moveInput').value.trim();
    const boardIndex = parseInt(document.getElementById('activeBoardSelect').value);
    
    if (!moveInput || !games[boardIndex]) return;
    
    try {
        let move = null;
        
        // Try standard algebraic notation
        move = games[boardIndex].move(moveInput);
        
        // If that fails, try from-to notation
        if (!move && moveInput.includes('-')) {
            const [from, to] = moveInput.split('-');
            move = games[boardIndex].move({ from: from.trim(), to: to.trim() });
        }
        
        if (move) {
            moveHistory[boardIndex].push({ move: move.san, player: 'white' });
            updateMoveHistoryDisplay();
            
            // Update board position
            boards[boardIndex].position(games[boardIndex].fen());
            
            // Make computer move
            setTimeout(() => makeComputerMove(boardIndex), 500);
            
            document.getElementById('moveInput').value = '';
        } else {
            alert('Invalid move! Try again.');
        }
    } catch (error) {
        alert('Invalid move format! Use notation like "e4", "Nf3", or "e2-e4"');
    }
}

async function makeComputerMove(boardIndex) {
    const moves = games[boardIndex].moves();
    
    if (moves.length === 0) {
        await endGame(boardIndex);
        return;
    }
    
    // Simple random move for opponent
    const randomMove = moves[Math.floor(Math.random() * moves.length)];
    games[boardIndex].move(randomMove);
    
    moveHistory[boardIndex].push({ move: randomMove, player: 'black' });
    updateMoveHistoryDisplay();
    
    // Update board position
    boards[boardIndex].position(games[boardIndex].fen());
    
    // Check if game is over
    if (games[boardIndex].game_over()) {
        await endGame(boardIndex);
    }
}

function updateMoveHistoryDisplay() {
    const boardIndex = parseInt(document.getElementById('activeBoardSelect').value);
    const historyDiv = document.getElementById('moveHistory');
    
    if (!moveHistory[boardIndex] || moveHistory[boardIndex].length === 0) {
        historyDiv.innerHTML = 'No moves yet';
        return;
    }
    
    historyDiv.innerHTML = '';
    let moveNumber = 1;
    
    for (let i = 0; i < moveHistory[boardIndex].length; i += 2) {
        const whiteMove = moveHistory[boardIndex][i];
        const blackMove = moveHistory[boardIndex][i + 1];
        
        let line = `<div><strong>${moveNumber}.</strong> `;
        if (whiteMove) {
            line += `<span class="text-primary">${whiteMove.move}</span>`;
        }
        if (blackMove) {
            line += ` <span class="text-danger">${blackMove.move}</span>`;
        }
        line += '</div>';
        
        historyDiv.innerHTML += line;
        moveNumber++;
    }
    
    historyDiv.scrollTop = historyDiv.scrollHeight;
}

async function endGame(boardIndex, silent = false) {
    if (!games[boardIndex]) return null;
    
    const duration = Math.floor((Date.now() - startTimes[boardIndex]) / 1000);
    let result = 'draw';
    
    if (games[boardIndex].in_checkmate()) {
        result = games[boardIndex].turn() === 'w' ? 'loss' : 'win';
    }
    
    // Save game
    const token = localStorage.getItem('token');
    if (token) {
        try {
            await fetch('/games/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    game_type: 'blind_play',
                    result: result,
                    moves: games[boardIndex].pgn(),
                    duration: duration
                })
            });
            
            if (!silent) {
                alert(`Board ${boardIndex + 1} game ended! Result: ${result}. Duration: ${duration}s`);
            }
            return { boardIndex, result, duration };
        } catch (error) {
            console.error('Failed to save game for board', boardIndex + 1);
            return null;
        }
    }
    return null;
}

async function endAllGames() {
    if (games.length === 0) return;
    
    if (confirm('Are you sure you want to end all games?')) {
        // End all games in parallel and collect results
        const endPromises = [];
        for (let i = 0; i < games.length; i++) {
            if (games[i]) {
                endPromises.push(endGame(i, true)); // silent = true to avoid multiple alerts
            }
        }
        
        // Wait for all games to be saved
        const results = await Promise.all(endPromises);
        
        // Show summary of all games
        const validResults = results.filter(r => r !== null);
        if (validResults.length > 0) {
            const summaryLines = validResults.map(r => 
                `Board ${r.boardIndex + 1}: ${r.result} (${r.duration}s)`
            );
            alert('All games ended:\n\n' + summaryLines.join('\n'));
        }
        
        // Reset UI
        document.getElementById('moveInput').disabled = true;
        document.getElementById('makeMoveBtn').disabled = true;
        document.getElementById('activeBoardSelect').disabled = true;
        document.getElementById('gameStatus').className = 'alert alert-info';
        document.getElementById('gameStatus').textContent = 'All games ended';
        document.getElementById('boardsContainer').innerHTML = '';
        document.getElementById('blindContainer').style.display = 'block';
        document.getElementById('startBtn').textContent = 'Start New Game';
    }
}

// Board selection change handler
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('moveInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            makeMove();
        }
    });
    
    document.getElementById('activeBoardSelect').addEventListener('change', function() {
        updateMoveHistoryDisplay();
    });
});
</script>
{% endblock %}
